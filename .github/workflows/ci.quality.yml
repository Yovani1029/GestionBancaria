name: CI Quality

on:
  push:
  pull_request:

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'

      - name: Instalar dependencias y verificar compilación
        run: mvn -B -U clean compile

      - name: Ejecutar linter (Checkstyle)
        run: mvn -B checkstyle:check

      - name: Ejecutar pruebas unitarias
        run: mvn -B test

      - name: Generar reporte de cobertura
        run: mvn -B jacoco:report

      - name: Validar cobertura mínima (80%)
        run: |
          echo "Validando cobertura mínima..."
          COVERAGE=$(xmllint --xpath "string(//report/counter[@type='INSTRUCTION']/@covered)" target/site/jacoco/jacoco.xml)
          MISSED=$(xmllint --xpath "string(//report/counter[@type='INSTRUCTION']/@missed)" target/site/jacoco/jacoco.xml)
          TOTAL=$((COVERAGE + MISSED))
          PERCENT=$((100 * COVERAGE / TOTAL))
          echo "Cobertura actual: $PERCENT%"

          if [ "$PERCENT" -lt 80 ]; then
            echo "La cobertura es menor a 80%."
            exit 1
          fi

      - name: Finalización exitosa
        if: success()
        run: echo "Pipeline completado correctamente."
