name: CI Quality

on:
  push:
  pull_request:

jobs:
  build-test:
    runs-on: ubuntu-latest
    container:
      image: maven:3.9.4-eclipse-temurin-21  # Java 21 + Maven preinstalado

    steps:
      # ✅ Checkout del repo
      - name: Checkout
        uses: actions/checkout@v4

      # ❌ Comentamos setup-java porque la imagen ya tiene Java 21
      # - name: Configurar JDK 21
      #   uses: actions/setup-java@v4
      #   with:
      #     java-version: '21'
      #     distribution: 'temurin'

      # ✅ Compilar proyecto y descargar dependencias
      - name: Instalar dependencias y verificar compilación
        run: mvn -B -U clean compile

      # ✅ Ejecutar linter (Checkstyle)
      - name: Ejecutar linter (Checkstyle)
        run: mvn -B checkstyle:check

      # ✅ Ejecutar pruebas unitarias
      - name: Ejecutar pruebas unitarias
        run: mvn -B test

      # ✅ Generar reporte de cobertura
      - name: Generar reporte de cobertura
        run: mvn -B jacoco:report

      # ✅ Instalar xmllint sin sudo (root en contenedor)
      - name: Install xmllint
        run: |
          apt-get update
          apt-get install -y libxml2-utils

      # ✅ Validar cobertura mínima 80%
      - name: Validar cobertura mínima (80%)
        run: |
          echo "Validando cobertura mínima..."
          COVERED=$(xmllint --xpath "string(//report/counter[@type='INSTRUCTION']/@covered)" target/site/jacoco/jacoco.xml)
          MISSED=$(xmllint --xpath "string(//report/counter[@type='INSTRUCTION']/@missed)" target/site/jacoco/jacoco.xml)
          TOTAL=$((COVERED + MISSED))
          PERCENT=$((100 * COVERED / TOTAL))
          echo "Cobertura actual: $PERCENT%"
          if [ "$PERCENT" -lt 80 ]; then
            echo "La cobertura es menor a 80%."
            exit 1
          fi

      # ✅ Mensaje de finalización exitosa
      - name: Finalización exitosa
        if: success()
        run: echo "Pipeline completado correctamente."
